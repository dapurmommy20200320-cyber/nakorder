<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dapur Mommy - Pesanan Online</title>
  <style>
    :root {
      --pink: #e21b70;
      --bg: #f7f7f7;
      --card: #fff;
      --text: #222;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      padding-bottom: 80px; /* Space for scrolling */
      color: var(--text);
    }

    /* HEADER */
    .header {
      background: var(--pink);
      padding: 16px;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0 0 10px; font-size: 20px; }

    .search.small {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 10px;
      border: none;
      width: 100%;
    }

    .cart-icon {
      background: #fff;
      color: var(--pink);
      border: none;
      border-radius: 99px;
      padding: 6px 12px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .cart-icon span {
      background: var(--pink);
      color: #fff;
      border-radius: 99px;
      padding: 2px 8px;
      font-size: 12px;
      min-width: 20px;
      text-align: center;
      display: none; /* Hidden if 0 */
    }

    /* KATEGORI */
    .kategori {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .kategori::-webkit-scrollbar { display: none; }

    .kategori button {
      background: #fff;
      color: var(--text);
      border: 1px solid #eee;
      padding: 8px 16px;
      border-radius: 99px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .kategori .active {
      background: var(--pink);
      color: #fff;
      border-color: var(--pink);
      box-shadow: 0 4px 10px rgba(226, 27, 112, 0.3);
    }

    /* MENU LIST */
    .menu-list {
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .menu-card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .menu-card.habis {
      opacity: 0.7;
      filter: grayscale(1);
    }

    .menu-img {
      width: 100%;
      padding-top: 66.66%;
      position: relative;
      background: #eee;
    }

    .menu-img img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .menu-info {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .menu-info h3 { margin: 0; font-size: 16px; line-height: 1.3; }
    
    .stok {
      font-size: 13px; margin: 4px 0;
    }
    
    .stok-hijau { color: #16a34a; font-weight: 700; }
    .stok-merah { color: #dc2626; font-weight: 700; }

    .badge-habis {
      position: absolute; top: 5px; left: 5px;
      background: red; color: white; padding: 2px 6px;
      font-size: 10px; border-radius: 4px; font-weight: bold; z-index: 2;
    }

    .price-row {
      display: flex; justify-content: space-between; align-items: center; margin-top: 5px;
    }
    
    .menu-card button {
      background: var(--pink); color: #fff; border: none;
      width: 32px; border-radius: 50%; font-size: 20px;
      height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    .menu-card button:disabled { background: #ccc; cursor: not-allowed; }

    /* CART MODAL */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 999;
      justify-content: center; align-items: flex-end;
    }
    @media (min-width: 600px) { .modal-overlay { align-items: center; } }

    .cart-box {
      background: #fff; width: 100%; max-width: 500px;
      padding: 20px; border-radius: 20px 20px 0 0;
      max-height: 90vh; overflow-y: auto;
      position: relative;
      animation: slideUp 0.3s ease-out;
    }
    @media (min-width: 600px) { .cart-box { border-radius: 16px; animation: fadeIn 0.2s ease-out; } }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .cart-box h2 { margin-top: 0; color: var(--pink); font-size: 20px; }

    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #eee; padding: 10px 0;
    }
    .cart-item .qty-control {
      display: flex; align-items: center; gap: 10px; background: #f1f1f1; padding: 4px; border-radius: 8px;
    }
    .cart-item .qty-control button {
      background: #fff; color: var(--text); border: none; width: 24px; height: 24px;
      border-radius: 4px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    .cart-total {
      font-weight: 800; font-size: 18px; margin: 20px 0; text-align: right;
    }

    .form-input {
      width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
    }

    .btn-submit {
      width: 100%; background: var(--pink); color: white; border: none; padding: 14px;
      border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;
    }

    .close { background: transparent; color: #888; border: none; width: 100%; margin-top: 10px; cursor: pointer; font-size: 14px; text-decoration: underline; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="header-top">
      <h1>Dapur Mommy</h1>
      <button class="cart-icon" id="cartBtnTop">
        ðŸ›’ <span id="cartCount">0</span>
      </button>
    </div>
    <input id="searchInput" class="search small" placeholder="ðŸ” Cari menu..." />
  </header>

  <!-- KATEGORI -->
  <div class="kategori" id="kategoriList"></div>

  <!-- MENU LIST -->
  <div class="menu-list" id="menuList">
    <p style="text-align:center; padding:20px; color:#888;">Memuatkan menu...</p>
  </div>

  <!-- CART MODAL -->
  <div class="modal-overlay" id="cartModal">
    <div class="cart-box">
      <h2>Troli Anda</h2>
      <div id="cartItems"></div>
      
      <div class="cart-total">
        Jumlah: <span id="totalPrice">RM0.00</span>
      </div>

      <!-- INPUT PELANGGAN -->
      <input id="nama" class="form-input" placeholder="Nama Penuh" required>
      <textarea id="alamat" class="form-input" placeholder="Alamat Penghantaran" rows="3" required></textarea>
      
      <!-- KAWASAN & BAYARAN -->
      <label style="font-size:12px; font-weight:bold; margin-bottom:5px; display:block;">Kawasan Penghantaran</label>
      <select id="kawasan" class="form-input" onchange="updateCartUI()">
        <option value="WALK-IN">Walk-in (Tiada Caj)</option>
        <option value="RESIDEN1">Residen 1 (+RM1.00)</option>
        <option value="LAIN-LAIN">Lain-lain / PR1MA (+RM2.00)</option>
      </select>

      <label style="font-size:12px; font-weight:bold; margin-bottom:5px; display:block;">Kaedah Pembayaran</label>
      <select id="pembayaran" class="form-input">
        <option value="CASH">CASH (Tunai)</option>
        <option value="QR">QR Code</option>
      </select>

      <button class="btn-submit" id="btnSubmit" onclick="submitOrder()">Hantar Order</button>
      <button class="close" id="closeCart">Tutup</button>
    </div>
  </div>

  <script>
    // GANTI DENGAN URL ANDA (Google Apps Script Web App URL)
    const API_URL = "https://script.google.com/macros/s/AKfycbymNCR6zuDguiPAldiuh2Orx5t0HmHY5cVfbvMHdiSt_VMOen8SquOIoBzFHy9jRajv8Q/exec";
    const WHATSAPP_NO = "601172431562";

    let menuData = [];
    let cart = [];

    /* ================= ELEMENT ================= */
    const menuList = document.getElementById("menuList");
    const kategoriWrap = document.getElementById("kategoriList");
    const cartModal = document.getElementById("cartModal");
    const cartItems = document.getElementById("cartItems");
    const totalPrice = document.getElementById("totalPrice");
    const cartCount = document.getElementById("cartCount");
    const cartBtnTop = document.getElementById("cartBtnTop");
    const searchInput = document.getElementById("searchInput");

    /* ================= LOAD MENU ================= */
    fetch(API_URL + "?action=menu")
      .then(r => r.json())
      .then(res => {
        if (!res.status) { alert("Gagal memuat menu: " + res.msg); return; }
        if (!res.data) return;

        const kategoriSet = new Set();
        const flat = [];

        Object.keys(res.data).forEach(cat => {
          kategoriSet.add(cat);
          res.data[cat].forEach(m => {
            flat.push({
              id: String(m.id),
              name: m.menu,
              price: Number(m.harga),
              stok: Number(m.stok),
              img: m.gambar || "",
              cat: cat.toLowerCase()
            });
          });
        });

        menuData = flat;
        renderKategori([...kategoriSet]);
        renderMenu(menuData);
      })
      .catch(err => { console.error("API ERROR:", err); alert("Sila semak kabel internet (API Error)."); });

    /* ================= RENDER MENU ================= */
    function renderMenu(data) {
      menuList.innerHTML = "";
      data.forEach(m => {
        const habis = m.stok <= 0;
        const displayImg = m.img ? m.img : `https://picsum.photos/seed/${m.id}/200/200`;

        menuList.innerHTML += `
          <div class="menu-card ${habis ? "habis" : ""}">
            <div class="menu-img">
              <img src="${displayImg}" alt="${m.name}">
              ${habis ? `<span class="badge-habis">HABIS</span>` : ""}
            </div>
            <div class="menu-info">
              <h3>${m.name}</h3>
              <p class="stok">Stok: <span class="${habis ? "stok-merah" : "stok-hijau"}">${habis ? "Habis" : m.stok}</span></p>
              <div class="price-row">
                <span>RM ${m.price.toFixed(2)}</span>
                <button ${habis ? "disabled" : ""} onclick="addToCart('${m.id}')">+</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    /* ================= RENDER KATEGORI ================= */
    function renderKategori(list) {
      kategoriWrap.innerHTML = `<button class="active" data-cat="all">Semua</button>`;
      list.forEach(k => kategoriWrap.innerHTML += `<button data-cat="${k.toLowerCase()}">${k}</button>`);

      kategoriWrap.querySelectorAll("button").forEach(btn => {
        btn.onclick = () => {
          kategoriWrap.querySelectorAll("button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const cat = btn.dataset.cat;
          renderMenu(cat === "all" ? menuData : menuData.filter(m => m.cat === cat));
        };
      });
    }

    /* ================= CART ================= */
    function addToCart(id) {
      const menuItem = menuData.find(m => m.id === id);
      if (!menuItem || menuItem.stok <= 0) return;

      let item = cart.find(c => c.id === id);
      if (item) { item.qty++; } 
      else { cart.push({ ...menuItem, qty: 1 }); }

      menuItem.stok--; // Kurangkan stok visual
      updateCartUI();
    }

    function changeQty(id, delta) {
      const item = cart.find(c => c.id === id);
      const menuItem = menuData.find(m => m.id === id);
      if (!item || !menuItem) return;
      
      if (delta > 0 && menuItem.stok <= 0) return;

      item.qty += delta;
      menuItem.stok -= delta; 

      if (item.qty <= 0) { cart = cart.filter(c => c.id !== id); }
      updateCartUI();
    }

    function updateCartUI() {
      const totalQty = cart.reduce((t, i) => t + i.qty, 0);
      cartCount.textContent = totalQty;
      cartCount.style.display = totalQty > 0 ? 'block' : 'none';

      renderMenu(menuData);
      renderCart();
    }

    /* ================= RENDER CART ================= */
    function renderCart() {
      cartItems.innerHTML = "";
      let total = 0;

      if (cart.length === 0) cartItems.innerHTML = "<p style='text-align:center; color:#999;'>Troli kosong.</p>";

      cart.forEach(c => {
        total += c.price * c.qty;
        cartItems.innerHTML += `
          <div class="cart-item">
            <div>
              <span style="font-weight:600; display:block;">${c.name}</span>
              <span style="font-size:12px; color:#666;">RM ${c.price.toFixed(2)} x ${c.qty}</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
              <div class="qty-control">
                <button onclick="changeQty('${c.id}',-1)">âˆ’</button>
                <span>${c.qty}</span>
                <button onclick="changeQty('${c.id}',1)">+</button>
              </div>
              <span style="font-weight:bold; width:70px; text-align:right;">RM ${(c.price * c.qty).toFixed(2)}</span>
            </div>
          </div>
        `;
      });

      // Hitung Caj Penghantaran untuk Paparan Saja
      let cajPenghantaran = 0;
      const kawasanEl = document.getElementById("kawasan");
      if (kawasanEl) {
        const kawasan = kawasanEl.value;
        if (kawasan === "RESIDEN1") cajPenghantaran = 1.00;
        else if (kawasan === "LAIN-LAIN") cajPenghantaran = 2.00;
      }
      
      // Total Display = Jumlah Item + Caj Penghantaran
      const grandTotalDisplay = total + cajPenghantaran;
      totalPrice.textContent = `RM ${grandTotalDisplay.toFixed(2)}`;
    }

    /* ================= SEARCH ================= */
    if (searchInput) {
      searchInput.oninput = () => {
        const v = searchInput.value.toLowerCase();
        renderMenu(menuData.filter(m => m.name.toLowerCase().includes(v)));
      };
    }

    /* ================= CART MODAL ================= */
    document.addEventListener("DOMContentLoaded", () => {
      if (cartBtnTop && cartModal) {
        cartBtnTop.onclick = () => { cartModal.style.display = "flex"; };
      }
      const closeCart = document.getElementById("closeCart");
      if (closeCart && cartModal) {
        closeCart.onclick = () => { cartModal.style.display = "none"; };
      }
      cartModal.onclick = (e) => { if (e.target === cartModal) cartModal.style.display = "none"; }
    });

    /* ================= SUBMIT ORDER ================= */
    function submitOrder() {
      if (!cart.length) { alert("Troli kosong"); return; }

      const nama = document.getElementById("nama").value;
      const alamat = document.getElementById("alamat").value;
      const kawasan = document.getElementById("kawasan").value;
      const pembayaran = document.getElementById("pembayaran").value;

      if (!nama || !alamat) { alert("Sila isi Nama dan Alamat"); return; }

      const payload = {
        action: "order",
        nama: nama,
        alamat: alamat,
        jenis: "ONLINE",
        kawasan: kawasan,
        bayaran: pembayaran,
        cod: 0,
        items: cart.map(i => ({ id: i.id, qty: i.qty }))
      };

      const submitBtn = document.getElementById("btnSubmit");
      const originalText = submitBtn.innerText;
      submitBtn.innerText = "Loading...";
      submitBtn.disabled = true;

      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" }, 
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(res => {
        if (!res.status) { alert("Order Gagal: " + res.msg); return; }

        const text = encodeURIComponent(res.data.whatsapp);
        window.open(`https://wa.me/${WHATSAPP_NO}?text=${text}`, "_blank");

        cart = [];
        cartModal.style.display = "none";
        document.getElementById("nama").value = "";
        document.getElementById("alamat").value = "";
        document.getElementById("kawasan").value = "WALK-IN";
        document.getElementById("pembayaran").value = "CASH";
        
        updateCartUI();
        alert("Order berjaya!");
      })
      .catch(err => { console.error("Full Error:", err); alert("Ralat sistem (Sila tekan F12 di browser untuk butiran)."); })
      .finally(() => {
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
      });
    }
  </script>
</body>
</html>